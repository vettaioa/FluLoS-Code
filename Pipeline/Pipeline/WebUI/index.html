<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
	
	<title>FluLoS Demo</title>
	<style>
	.microphone {
		width: 30px;
		cursor: pointer;
	}
	.microphone.recording path {
		animation: mic-active 3s linear 0s infinite normal;
	}
	@keyframes mic-active {
		0%{ fill: #4d0e04; }
		50%{ fill: #ad200a; }
		100%{ fill: #4d0e04; }
	}
	</style>

</head>
<body>
	<div class="container mt-5">
		<div class="row justify-content-md-center">
			<div class="col-md-8">
				<h1>FluLoS Web Demo</h1>
				<div class="audioerr alert alert-danger d-none" role="alert">Unknown Error!</div>
				<div class="microphone">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512"><path d="M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"/></svg>
				</div>
				<code class="result"></code>
			</div>
		</div>
	</div>
<script>
// Callbacks
const StartRecording = (mediaRecorder) => {
	console.debug('start recording...');
	mediaRecorder.start();
	isRecording = true;
	microphoneBtn.classList.add('recording')
}
const StopRecording = (mediaRecorder) => {
	console.debug('stop recording');
	mediaRecorder.stop();
	isRecording = false;
	microphoneBtn.classList.remove('recording')
}

const SendRecording = (blob) => {
	fetch('/process', {
		method: 'post',
		body: blob,
	})
	.then(res => res.text())
	.then(data => {
		resultBox.innerHTML = data;
	})
}

// Main Code
const errorBox = document.getElementsByClassName('audioerr')[0]
const microphoneBtn = document.getElementsByClassName('microphone')[0]
const resultBox = document.getElementsByClassName('result')[0]

let isRecording = false;

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia
	&& MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
	navigator.mediaDevices.getUserMedia({ audio: true })
	  .then(function(stream) {
		const mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm;codecs=opus'})
		
		let chunks = []
		mediaRecorder.ondataavailable = function(e) {
			console.log('got chunk', e.data);
			chunks.push(e.data);
		}
		
		mediaRecorder.onstop = () => {
			const blob = new Blob(chunks, { 'type' : 'audio/webm;codecs=opus' });
			SendRecording(blob);
		}
		
		microphoneBtn.onclick = () => {
			if(!isRecording) {
				chunks = []
				StartRecording(mediaRecorder);
			} else {
				StopRecording(mediaRecorder, chunks);
			}
		  };
      })
      .catch(function(err) {
		 errorBox.innerHTML = '<b>Audio Support Error</b>:<br>' + err;
         errorBox.classList.remove('d-none')
      })
} else {
	errorBox.innerHTML = '<b>Your browser doesn not support audio input</b>';
	errorBox.classList.remove('d-none')
}


</script>
</body>
</html>